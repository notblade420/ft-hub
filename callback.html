<!DOCTYPE html>
<html>
<head>
  <title>Spotify Callback</title>
</head>
<body style="background:#111;color:#e0ffe0;font-family:sans-serif;text-align:center;padding:4rem;">
  <h2>Handling Spotify Login...</h2>
  <p id="status">Just a moment...</p>

  <script>
    const code = new URLSearchParams(window.location.search).get("code");
    const codeVerifier = localStorage.getItem("code_verifier");
    const redirectUri = "https://ft-hub-v2-420.netlify.app/callback.html";
    const status = document.getElementById("status");

    if (!code || !codeVerifier) {
      status.textContent = "Authorization failed. Missing code or verifier.";
      console.error("Missing code or code_verifier in URL/localStorage.");
    } else {
      status.textContent = "Contacting token server...";

      fetch("https://ft-hub.onrender.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code,
          code_verifier: codeVerifier,
          redirect_uri: redirectUri
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Token response:", data);
        if (data.access_token) {
          localStorage.setItem("spotify_token", data.access_token);
          status.textContent = "Login successful. Redirecting to music player...";
          setTimeout(() => window.location.href = "music.html", 1500);
        } else {
          status.textContent = "Token exchange failed. Please try again.";
          console.error(data);
        }
      })
      .catch(err => {
        status.textContent = "Network error during token exchange.";
        console.error(err);
      });
    }
  </script>
</body>
</html>
